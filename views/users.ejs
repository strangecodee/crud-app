<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Users - User Management</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" />
  <link rel="stylesheet" href="/style.css" />
</head>

<body class="bg-light">

  <!-- Toast container -->
  <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1100;">
    <div id="toastContainer" class="toast-container"></div>
  </div>

  <div class="container-custom fade-in-up">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h1 class="mb-0">
        <i class="bi bi-people-fill text-primary me-2"></i>
        All Users
      </h1>
      <% if (typeof currentUser !== 'undefined' && currentUser && currentUser.username) { %>
        <form action="/logout" method="POST" class="d-flex align-items-center gap-2">
          <span class="text-muted small">Logged in as <strong><%= currentUser.username %></strong></span>
          <button type="submit" class="btn btn-outline-secondary btn-sm">
            <i class="bi bi-box-arrow-right me-1"></i>
            Logout
          </button>
        </form>
      <% } %>
    </div>

    <div class="mb-4 d-flex justify-content-between align-items-center">
      <a href="/add" class="btn btn-success">
        <i class="bi bi-plus-circle-fill me-2"></i>
        Add New User
      </a>
      <div>
        <a href="/export" class="btn btn-primary me-2">
          <i class="bi bi-download me-2"></i>
          Export CSV
        </a>
        <form action="/upload" method="POST" enctype="multipart/form-data" class="d-inline" id="uploadForm">
          <input type="file" name="file" id="fileInput" class="d-none" accept=".csv,.txt,.json" />
          <button type="button" class="btn btn-info me-2" id="chooseFileBtn">
            <i class="bi bi-folder2-open me-2"></i>
            Choose File
          </button>
          <button type="submit" class="btn btn-primary" id="uploadBtn" disabled>
            <i class="bi bi-upload me-2"></i>
            Upload
          </button>
          <span id="selectedFileName" class="ms-2 text-muted small"></span>
        </form>
      </div>
    </div>

    <!-- Search and Filter -->
    <div class="mb-4">
      <form method="GET" action="/users" class="row g-3">
        <div class="col-md-6">
          <input type="text" name="search" class="form-control" placeholder="Search by name or email..." value="<%= (typeof search !== 'undefined' ? search : '') %>" />
        </div>
        <div class="col-md-3">
          <select name="filter" class="form-select">
            <option value="">All Fields</option>
            <option value="name" <%= (typeof filter !== 'undefined' && filter === 'name') ? 'selected' : '' %>>Name Only</option>
            <option value="email" <%= (typeof filter !== 'undefined' && filter === 'email') ? 'selected' : '' %>>Email Only</option>
          </select>
        </div>
        <div class="col-md-3">
          <button type="submit" class="btn btn-outline-primary w-100">
            <i class="bi bi-search me-2"></i>
            Search
          </button>
        </div>
      </form>
    </div>

    <div class="card">
      <form id="bulkDeleteForm" method="POST" action="/users/bulk-delete">
        <div class="card-body p-0">
          <div class="d-flex justify-content-between align-items-center px-3 pt-3 pb-2">
            <span class="text-muted small">Bulk actions</span>
            <button type="button" class="btn btn-sm btn-outline-danger" id="bulkDeleteBtn">
              <i class="bi bi-trash-fill me-1"></i>
              Delete Selected
            </button>
          </div>
          <table class="table table-hover mb-0 table-custom">
            <thead>
              <tr>
                <th class="text-center" style="width: 40px;">
                  <input type="checkbox" id="selectAll" class="form-check-input" />
                </th>
                <th class="text-center">
                  <a class="text-decoration-none" href="?page=<%= currentPage %>&limit=<%= limit %>&search=<%= (typeof search !== 'undefined' ? search : '') %>&filter=<%= (typeof filter !== 'undefined' ? filter : '') %>&sort=id&direction=<%= (currentSort === 'id' && currentDirection === 'asc') ? 'desc' : 'asc' %>">
                    <i class="bi bi-hash text-primary me-1"></i>
                    ID
                    <% if (currentSort === 'id') { %>
                      <i class="bi <%= currentDirection === 'asc' ? 'bi-caret-up-fill' : 'bi-caret-down-fill' %> ms-1"></i>
                    <% } %>
                  </a>
                </th>
                <th>
                  <a class="text-decoration-none" href="?page=<%= currentPage %>&limit=<%= limit %>&search=<%= (typeof search !== 'undefined' ? search : '') %>&filter=<%= (typeof filter !== 'undefined' ? filter : '') %>&sort=name&direction=<%= (currentSort === 'name' && currentDirection === 'asc') ? 'desc' : 'asc' %>">
                    <i class="bi bi-person-fill text-primary me-1"></i>
                    Name
                    <% if (currentSort === 'name') { %>
                      <i class="bi <%= currentDirection === 'asc' ? 'bi-caret-up-fill' : 'bi-caret-down-fill' %> ms-1"></i>
                    <% } %>
                  </a>
                </th>
                <th>
                  <a class="text-decoration-none" href="?page=<%= currentPage %>&limit=<%= limit %>&search=<%= (typeof search !== 'undefined' ? search : '') %>&filter=<%= (typeof filter !== 'undefined' ? filter : '') %>&sort=email&direction=<%= (currentSort === 'email' && currentDirection === 'asc') ? 'desc' : 'asc' %>">
                    <i class="bi bi-envelope-fill text-primary me-1"></i>
                    Email
                    <% if (currentSort === 'email') { %>
                      <i class="bi <%= currentDirection === 'asc' ? 'bi-caret-up-fill' : 'bi-caret-down-fill' %> ms-1"></i>
                    <% } %>
                  </a>
                </th>
                <th class="text-center">
                  <i class="bi bi-gear-fill text-primary me-1"></i>
                  Actions
                </th>
              </tr>
            </thead>
            <tbody>
              <% if (users.length === 0) { %>
              <tr>
                <td colspan="4" class="text-center py-5">
                  <div class="text-muted">
                    <h5>
                      <i class="bi bi-inbox-fill me-2"></i>
                      No users found
                    </h5>
                    <p>Start by adding your first user!</p>
                    <a href="/add" class="btn btn-primary">
                      <i class="bi bi-plus-circle-fill me-2"></i>
                      Add First User
                    </a>
                  </div>
                </td>
              </tr>
            <% } else { users.forEach(user => { %>
              <tr>
                <td class="text-center">
                  <input type="checkbox" name="ids" value="<%= user.id %>" class="form-check-input user-select-checkbox" />
                </td>
                <td class="text-center fw-bold">#<%= user.id %></td>
                <td class="fw-semibold"><%= user.name %></td>
                <td><%= user.email %></td>
                <td class="text-center">
                  <div class="btn-group" role="group">
                    <a href="/users/<%= user.id %>" class="btn btn-info btn-sm" title="View Details">
                      <i class="bi bi-eye-fill"></i>
                    </a>
                    <button class="btn btn-warning btn-sm" onclick="openEditModal('<%= user.id %>', '<%= user.name %>', '<%= user.email %>')" title="Edit User">
                      <i class="bi bi-pencil-fill"></i>
                    </button>
                    <form action="/delete/<%= user.id %>" method="POST" style="display:inline;">
                      <button type="submit" class="btn btn-danger btn-sm" onclick="return confirm('Are you sure you want to delete <%= user.name %>?')" title="Delete User">
                        <i class="bi bi-trash-fill"></i>
                      </button>
                    </form>
                  </div>
                </td>
              </tr>
            <% }) } %>
          </tbody>
        </table>
      </div>
      </form>
    </div>

    <!-- Pagination -->
    <% if (totalPages > 1) { %>
      <nav aria-label="User pagination" class="mt-4">
        <ul class="pagination justify-content-center">
          <% if (currentPage > 1) { %>
            <li class="page-item">
              <a class="page-link" href="?page=<%= currentPage - 1 %>&search=<%= (typeof search !== 'undefined' ? search : '') %>&filter=<%= (typeof filter !== 'undefined' ? filter : '') %>&limit=<%= limit %>&sort=<%= currentSort %>&direction=<%= currentDirection %>">Previous</a>
            </li>
          <% } %>

          <% for (let i = Math.max(1, currentPage - 2); i <= Math.min(totalPages, currentPage + 2); i++) { %>
            <li class="page-item <%= i === currentPage ? 'active' : '' %>">
              <a class="page-link" href="?page=<%= i %>&search=<%= (typeof search !== 'undefined' ? search : '') %>&filter=<%= (typeof filter !== 'undefined' ? filter : '') %>&limit=<%= limit %>&sort=<%= currentSort %>&direction=<%= currentDirection %>"><%= i %></a>
            </li>
          <% } %>

          <% if (currentPage < totalPages) { %>
            <li class="page-item">
              <a class="page-link" href="?page=<%= currentPage + 1 %>&search=<%= (typeof search !== 'undefined' ? search : '') %>&filter=<%= (typeof filter !== 'undefined' ? filter : '') %>&limit=<%= limit %>&sort=<%= currentSort %>&direction=<%= currentDirection %>">Next</a>
            </li>
          <% } %>
        </ul>
      </nav>
    <% } %>

    <!-- Upload status messages are now shown via Bootstrap toasts (see script block below). -->

    <div class="text-center mt-4">
      <p class="text-muted">Showing <%= users.length %> of <%= totalUsers %> users</p>
      <a href="/" class="nav-link">‚Üê Back to Dashboard</a>
    </div>
  </div>

  <!-- View Modal -->
  <div class="modal fade" id="viewModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header"><h5>User Details</h5></div>
        <div class="modal-body" id="viewUserBody"></div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Edit Modal -->
  <div class="modal fade" id="editModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <form id="editForm">
          <div class="modal-header"><h5>Edit User</h5></div>
          <div class="modal-body">
            <input type="hidden" id="editId" />
            <div class="mb-3">
              <label>Name</label>
              <input type="text" id="editName" class="form-control" required />
            </div>
            <div class="mb-3">
              <label>Email</label>
              <input type="email" id="editEmail" class="form-control" required />
            </div>
          </div>
          <div class="modal-footer">
            <button type="submit" class="btn btn-success">Save</button>
            <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // Generic Bootstrap toast helper
    function showToast(variant, title, message) {
      var container = document.getElementById('toastContainer');
      if (!container) return;

      var toastEl = document.createElement('div');
      toastEl.className = 'toast align-items-center text-bg-' + variant + ' border-0 mb-2';
      toastEl.setAttribute('role', 'alert');
      toastEl.setAttribute('aria-live', 'assertive');
      toastEl.setAttribute('aria-atomic', 'true');

      toastEl.innerHTML =
        '<div class="d-flex">' +
          '<div class="toast-body">' +
            '<strong>' + title + ':</strong> ' + message +
          '</div>' +
          '<button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>' +
        '</div>';

      container.appendChild(toastEl);

      var toast = new bootstrap.Toast(toastEl, { delay: 4000 });
      toast.show();

      toastEl.addEventListener('hidden.bs.toast', function () {
        toastEl.remove();
      });
    }

    function openEditModal(id, name, email) {
      document.getElementById('editId').value = id;
      document.getElementById('editName').value = name;
      document.getElementById('editEmail').value = email;
      new bootstrap.Modal(document.getElementById('editModal')).show();
    }

    document.getElementById('editForm').addEventListener('submit', async function (e) {
      e.preventDefault();
      const id = document.getElementById('editId').value;
      const name = document.getElementById('editName').value;
      const email = document.getElementById('editEmail').value;

      try {
        const response = await fetch(`/update/${id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, email }),
        });

        if (response.ok) {
          showToast('success', 'User updated', 'User updated successfully');
          setTimeout(function () { location.reload(); }, 800);
        } else {
          showToast('danger', 'Update failed', 'There was an error updating the user');
        }
      } catch (err) {
        console.error(err);
        showToast('danger', 'Update failed', 'Unexpected error while updating the user');
      }
    });

    // File upload handling (select then click Upload)
    (function () {
      var fileInput = document.getElementById('fileInput');
      var chooseBtn = document.getElementById('chooseFileBtn');
      var uploadBtn = document.getElementById('uploadBtn');
      var fileNameLabel = document.getElementById('selectedFileName');

      if (chooseBtn && fileInput) {
        chooseBtn.addEventListener('click', function () {
          fileInput.click();
        });
      }

      if (fileInput && uploadBtn) {
        fileInput.addEventListener('change', function () {
          if (this.files.length > 0) {
            var name = this.files[0].name;
            console.log('File selected:', name);
            uploadBtn.disabled = false;
            if (fileNameLabel) {
              fileNameLabel.textContent = name;
            }
          } else {
            uploadBtn.disabled = true;
            if (fileNameLabel) {
              fileNameLabel.textContent = '';
            }
          }
        });
      }
    })();

    // Bulk delete handlers
    (function () {
      var selectAll = document.getElementById('selectAll');
      var bulkBtn = document.getElementById('bulkDeleteBtn');
      var form = document.getElementById('bulkDeleteForm');

      if (selectAll) {
        selectAll.addEventListener('change', function () {
          var checkboxes = document.querySelectorAll('.user-select-checkbox');
          checkboxes.forEach(function (cb) { cb.checked = selectAll.checked; });
        });
      }

      if (bulkBtn && form) {
        bulkBtn.addEventListener('click', function () {
          var checkboxes = Array.prototype.slice.call(document.querySelectorAll('.user-select-checkbox'));
          var selected = checkboxes.filter(function (cb) { return cb.checked; });

          if (selected.length === 0) {
            showToast('warning', 'No users selected', 'Please select at least one user to delete.');
            return;
          }

          if (!confirm('Are you sure you want to delete ' + selected.length + ' selected user(s)?')) {
            return;
          }

          form.submit();
        });
      }
    })();

    // Server-side upload & bulk-delete status -> toasts
    document.addEventListener('DOMContentLoaded', function () {
      <% if (typeof upload !== 'undefined' && upload) { %>
        <% if (upload === 'success') { %>
          showToast(
            'success',
            'Upload complete',
            'File uploaded and processed successfully.'<% if (typeof imported !== "undefined" && imported) { %> + ' Imported: <%= imported %>, Skipped: <%= skipped || 0 %>, Errors: <%= errors || 0 %>.'<% } %>
          );
          setTimeout(function () { window.location.href = '/users'; }, 3000);
        <% } else if (upload === 'no-file') { %>
          showToast('warning', 'No file', 'No file was selected for upload.');
        <% } else if (upload === 'invalid-type') { %>
          showToast('danger', 'Invalid file', 'Invalid file type. Please upload a CSV file.');
        <% } else if (upload === 'file-too-large') { %>
          showToast('danger', 'File too large', 'File is too large. Maximum size is 5MB.');
        <% } else if (upload === 'empty-file') { %>
          showToast('warning', 'Empty file', 'The uploaded file is empty.');
        <% } else if (upload === 'insufficient-data') { %>
          showToast('warning', 'Insufficient data', 'CSV file must contain at least a header row and one data row.');
        <% } else if (upload === 'missing-columns') { %>
          showToast('danger', 'Missing columns', "CSV file must contain 'name' and 'email' columns.");
        <% } else if (upload === 'partial-success') { %>
          showToast('warning', 'Partial success', 'File processed with some errors. Check the console logs for details.');
        <% } else if (upload === 'no-new-users') { %>
          showToast('info', 'No new users', 'No new users were imported. All records may already exist or be invalid.');
        <% } else if (upload === 'server-error') { %>
          showToast('danger', 'Server error', 'Server error occurred during file processing. Please try again.');
        <% } %>
      <% } %>

      <% if (typeof bulk !== 'undefined' && bulk) { %>
        <% if (bulk === 'deleted') { %>
          showToast('success', 'Users deleted', '<%= deletedCount || 0 %> user(s) deleted successfully.');
        <% } else if (bulk === 'none-selected') { %>
          showToast('warning', 'No users selected', 'Please select at least one user to delete.');
        <% } else if (bulk === 'server-error') { %>
          showToast('danger', 'Delete failed', 'An error occurred while deleting users.');
        <% } %>
      <% } %>
    });
  </script>
</body>
</html>  
