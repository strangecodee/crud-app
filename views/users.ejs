<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Users - User Management</title>
  <link href="./output.css" rel="stylesheet">
</head>

<body class="bg-gray-100">

  <!-- Toast container -->
  <div id="toastContainer" class="fixed bottom-4 right-4 space-y-3 z-1100"></div>

  <!-- Main Container -->
  <div class="max-w-6xl mx-auto px-4 py-8 animate-fade-in-up">

    <a href="/" class="text-blue-600 hover:underline mt-2 inline-block">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6">
        <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 19.5 3 12m0 0 7.5-7.5M3 12h18" />
      </svg>
    </a>

    <!-- Header -->
    <div class="flex items-center justify-between mb-6">
      <h1 class="flex items-center justify-center gap-4 text-3xl font-bold text-gray-900 px-2">

        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="#2563eb" class="size-6">
          <path stroke-linecap="round" stroke-linejoin="round" d="M18 18.72a9.094 9.094 0 0 0 3.741-.479 3 3 0 0 0-4.682-2.72m.94 3.198.001.031c0 .225-.012.447-.037.666A11.944 11.944 0 0 1 12 21c-2.17 0-4.207-.576-5.963-1.584A6.062 6.062 0 0 1 6 18.719m12 0a5.971 5.971 0 0 0-.941-3.197m0 0A5.995 5.995 0 0 0 12 12.75a5.995 5.995 0 0 0-5.058 2.772m0 0a3 3 0 0 0-4.681 2.72 8.986 8.986 0 0 0 3.74.477m.94-3.197a5.971 5.971 0 0 0-.94 3.197M15 6.75a3 3 0 1 1-6 0 3 3 0 0 1 6 0Zm6 3a2.25 2.25 0 1 1-4.5 0 2.25 2.25 0 0 1 4.5 0Zm-13.5 0a2.25 2.25 0 1 1-4.5 0 2.25 2.25 0 0 1 4.5 0Z" />
        </svg>

        All Users
      </h1>

      <% if (currentUser && currentUser.username) { %>
      <form action="/logout" method="POST" class="flex items-center gap-3">
        <span class="text-gray-500 text-sm">
          Logged in as <strong><%= currentUser.username %></strong>
        </span>

        <button type="submit"
          class="flex items-center gap-1 border border-gray-400 text-gray-700 hover:bg-gray-100 px-3 py-1.5 text-sm rounded-md transition">

          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-5">
            <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 9V5.25A2.25 2.25 0 0 1 10.5 3h6a2.25 2.25 0 0 1 2.25 2.25v13.5A2.25 2.25 0 0 1 16.5 21h-6a2.25 2.25 0 0 1-2.25-2.25V15m-3 0-3-3m0 0 3-3m-3 3H15" />
          </svg>
          Logout
        </button>
      </form>
      <% } %>
    </div>

    <!-- Action Buttons -->
    <div class="flex items-center justify-between mb-8">
      <a href="/add"
        class="flex items-center gap-2 bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 transition">

        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="#fff" class="size-5">
          <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v6m3-3H9m12 0a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
        </svg>

        Add New User
      </a>

      <div class="flex items-center gap-3">

        <a href="/export"
          class="flex items-center gap-2 bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition">

          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="#fff" class="size-4">
            <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5M16.5 12 12 16.5m0 0L7.5 12m4.5 4.5V3" />
          </svg>

          Download CSV
        </a>

        <form action="/upload" method="POST" enctype="multipart/form-data" id="uploadForm" class="flex items-center gap-3">

          <input type="file" name="file" id="fileInput" class="hidden" accept=".csv,.txt,.json" />

          <button type="button" id="chooseFileBtn"
            class="flex items-center gap-2 bg-cyan-600 text-white px-4 py-2 rounded-md hover:bg-cyan-700 transition cursor-pointer">

            <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24" class="size-5">
              <path d="M12 10.5v6m3-3H9m4.06-7.19-2.12-2.12a1.5 1.5 0 0 0-1.061-.44H4.5A2.25 2.25 0 0 0 2.25 6v12a2.25 2.25 0 0 0 2.25 2.25h15A2.25 2.25 0 0 0 21.75 18V9a2.25 2.25 0 0 0-2.25-2.25h-5.379a1.5 1.5 0 0 1-1.06-.44Z" />
            </svg>

            Choose File
          </button>

          <button type="submit" id="uploadBtn" disabled
            class="flex items-center gap-2 bg-blue-600 disabled:opacity-50 disabled:cursor-not-allowed text-white px-4 py-2 rounded-md hover:bg-blue-700 transition cursor-pointer">

            <svg xmlns="http://www.w3.org/2000/svg" class="size-4" viewBox="0 0 24 24">
              <path fill="#fff" d="M8.71 7.71L11 5.41V15a1 1 0 0 0 2 0V5.41l2.29 2.3a1 1 0 0 0 1.42 0a1 1 0 0 0 0-1.42l-4-4a1 1 0 0 0-.33-.21a1 1 0 0 0-.76 0a1 1 0 0 0-.33.21l-4 4a1 1 0 1 0 1.42 1.42ZM21 14a1 1 0 0 0-1 1v4a1 1 0 0 1-1 1H5a1 1 0 0 1-1-1v-4a1 1 0 0 0-2 0v4a3 3 0 0 0 3 3h14a3 3 0 0 0 3-3v-4a1 1 0 0 0-1-1Z" />
            </svg>

            Upload
          </button>

          <span id="selectedFileName" class="text-sm text-gray-500"></span>

        </form>

      </div>
    </div>

    <!-- Search -->
    <div class="mb-8">
      <form method="GET" action="/users" class="grid grid-cols-1 md:grid-cols-3 gap-4">

        <input type="text" name="search"
          value="<%= search || '' %>"
          placeholder="Search by name or email..."
          class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">

        <select name="filter"
          class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
          <option value="">All Fields</option>
          <option value="name" <%= filter === 'name' ? 'selected' : '' %>>Name Only</option>
          <option value="email" <%= filter === 'email' ? 'selected' : '' %>>Email Only</option>
        </select>

        <button type="submit"
          class="flex items-center justify-center gap-2 border border-blue-600 text-blue-600 hover:bg-blue-50 px-4 py-2 rounded-md transition w-full">

          <svg xmlns="http://www.w3.org/2000/svg" class="size-5" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round"
              d="M21 21l-4.35-4.35M16.65 10.5a6.15 6.15 0 1 1-12.3 0 6.15 6.15 0 0 1 12.3 0z" />
          </svg>

          Search
        </button>

      </form>
    </div>

    <!-- Table -->
    <div class="bg-white shadow rounded-lg overflow-hidden">
      <form id="bulkDeleteForm" method="POST" action="/users/bulk-delete">

        <div class="flex items-center justify-between px-4 py-3 border-b border-gray-200">
          <span class="text-gray-500 text-sm">Bulk actions</span>

          <button type="button" id="bulkDeleteBtn" disabled
            class="flex items-center gap-2 bg-red-600 hover:bg-red-700 disabled:opacity-50 disabled:cursor-not-allowed cursor-pointer text-white text-sm px-3 py-1.5 rounded-md transition">

            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-4">
              <path stroke-linecap="round" stroke-linejoin="round" d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0" />
            </svg>

            Delete Selected
          </button>
        </div>

        <div class="overflow-x-auto">
          <table class="min-w-full text-left text-sm text-gray-800">

            <thead class="bg-gray-100 border-b border-gray-200">
              <tr>

                <th class="px-4 py-3 text-center w-12">
                  <input type="checkbox" id="selectAll" class="size-4 rounded border-gray-400 focus:ring-blue-500">
                </th>

                <th class="px-4 py-3 text-center">
                  ID
                </th>

                <th class="px-4 py-3">
                  Name
                </th>

                <th class="px-4 py-3">
                  Email
                </th>

                <th class="px-4 py-3">
                  Actions
                </th>

              </tr>
            </thead>

            <tbody>

              <% if (users.length === 0) { %>
              <tr>
                <td colspan="5" class="py-10 text-center text-gray-500">
                  No users found
                </td>
              </tr>

              <% } else { users.forEach(user => { %>

              <tr class="border-b last:border-0 hover:bg-gray-50 transition">

                <td class="px-4 py-3 text-center">
                  <input type="checkbox" name="ids" value="<%= user.id %>"
                    class="user-select-checkbox size-4 rounded border-gray-400 focus:ring-blue-500">
                </td>

                <td class="px-4 py-3 text-center font-semibold text-gray-700">
                  #<%= user.id %>
                </td>

                <td class="px-4 py-3 font-medium text-gray-800">
                  <%= user.name %>
                </td>

                <td class="px-4 py-3 text-gray-700">
                  <%= user.email %>
                </td>

                <td class="px-4 py-3">
                  <div class="flex justify-center gap-2">

                    <a href="/users/<%= user.id %>"
                      class="bg-cyan-600 hover:bg-cyan-700 text-white p-2 rounded-md transition">
                      View
                    </a>

                    <button type="button"
                      onclick="openEditModal('<%= user.id %>', '<%= user.name %>', '<%= user.email %>')"
                      class="bg-yellow-500 hover:bg-yellow-600 text-white p-2 rounded-md transition">
                      Edit
                    </button>

                    <form action="/delete/<%= user.id %>" method="POST" class="inline">
                      <button type="submit"
                        class="bg-red-600 hover:bg-red-700 text-white p-2 rounded-md transition"
                        onclick="return confirm('Are you sure you want to delete <%= user.name %>?')">
                        Delete
                      </button>
                    </form>

                  </div>
                </td>

              </tr>

              <% }) } %>

            </tbody>

          </table>
        </div>

      </form>
    </div>

    <div class="text-center mt-6">
      <p class="text-gray-500">Showing <%= users.length %> of <%= totalUsers %> users</p>
    </div>

  </div>

<!-- ========================= -->
<!-- VIEW & EDIT MODALS        -->
<!-- ========================= -->

<div id="viewModal"
     class="fixed inset-0 bg-black/40 backdrop-blur-sm hidden items-center justify-center z-100 transition-opacity duration-200">

  <div class="bg-white w-full max-w-md rounded-lg shadow-lg p-6
       transform transition-all duration-200 scale-95 opacity-0"
       id="viewModalContent">

    <div class="flex justify-between items-center mb-4">
      <h2 class="text-xl font-bold text-gray-800">User Details</h2>

      <button onclick="closeViewModal()" class="text-gray-600 hover:text-gray-800 transition">
        ✖
      </button>
    </div>

    <div id="viewModalBody" class="text-gray-700 space-y-2"></div>

    <div class="mt-5 text-right">
      <button onclick="closeViewModal()"
        class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-md">
        Close
      </button>
    </div>

  </div>
</div>

<div id="editModal"
     class="fixed inset-0 bg-black/40 backdrop-blur-sm hidden items-center justify-center z-200 transition-opacity duration-200"
     onclick="closeEditModal()">

  <div class="bg-white w-full max-w-md rounded-lg shadow-lg p-6
       transform transition-all duration-200 scale-95 opacity-0"
       id="editModalContent" onclick="event.stopPropagation()">

    <div class="flex justify-between items-center mb-4">
      <h2 class="text-xl font-bold text-gray-800">Edit User</h2>

      <button onclick="closeEditModal()" class="text-gray-600 hover:text-gray-800 transition">
        ✖
      </button>
    </div>

    <form id="editUserForm" method="POST" onsubmit="handleEditSubmit(event)">

      <input type="hidden" name="_method" value="PUT">
      <input type="hidden" name="id" id="editUserId">

      <div class="mb-3">
        <label class="block mb-1 font-medium">Name</label>
        <input type="text" name="name" id="editUserName"
          class="px-3 py-2 border border-gray-300 rounded-md w-full focus:ring-2 focus:ring-blue-500">
      </div>

      <div class="mb-3">
        <label class="block mb-1 font-medium">Email</label>
        <input type="email" name="email" id="editUserEmail"
          class="px-3 py-2 border border-gray-300 rounded-md w-full focus:ring-2 focus:ring-blue-500">
      </div>

      <div class="mt-5 flex justify-end gap-2">
        <button type="button" onclick="closeEditModal()"
          class="px-4 py-2 border border-gray-300 text-gray-600 hover:bg-gray-100 rounded-md">
          Cancel
        </button>

        <button type="submit"
          class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-md">
          Save Changes
        </button>
      </div>

    </form>

  </div>
</div>

<!-- ========================= -->
<!--       FIXED TOAST        -->
<!-- ========================= -->
<script>
function showToast(message, type = "info") {
  const container = document.getElementById("toastContainer");

  const colors = {
    success: "bg-green-600",
    danger: "bg-red-600",
    warning: "bg-yellow-500",
    info: "bg-blue-600"
  };

  const toast = document.createElement("div");
  toast.className =
    `text-white px-4 py-3 rounded shadow flex items-center gap-2 animate-fade-in-up ${colors[type]}`;

  toast.innerHTML = `
    <span>\${message}</span>
    <button onclick="this.parentElement.remove()" class="ml-2 hover:text-gray-300">
      &times;
    </button>
  `;

  container.appendChild(toast);

  setTimeout(() => {
    toast.style.opacity = "0";
    toast.style.transform = "translateY(-8px)";
    setTimeout(() => toast.remove(), 300);
  }, 3000);
}
</script>

<!-- ========================= -->
<!--         PAGE JS           -->
<!-- ========================= -->
<script>

function animateModalOpen(modal, content) {
  modal.classList.remove("hidden");
  setTimeout(() => {
    modal.classList.add("flex");
    content.classList.remove("opacity-0", "scale-95");
  }, 10);
}

function animateModalClose(modal, content) {
  content.classList.add("opacity-0", "scale-95");
  setTimeout(() => {
    modal.classList.add("hidden");
    modal.classList.remove("flex");
  }, 150);
}

function openViewModal(name, email, id) {
  document.getElementById("viewModalBody").innerHTML = `
    <p><strong>ID:</strong> ${id}</p>
    <p><strong>Name:</strong> ${name}</p>
    <p><strong>Email:</strong> ${email}</p>
  `;
  animateModalOpen(viewModal, viewModalContent);
}

function closeViewModal() {
  animateModalClose(viewModal, viewModalContent);
}

function openEditModal(id, name, email) {
  editUserId.value = id;
  editUserName.value = name;
  editUserEmail.value = email;
  editUserForm.action = "/update/" + id;

  animateModalOpen(editModal, editModalContent);
}

function closeEditModal() {
  animateModalClose(editModal, editModalContent);
}

document.addEventListener("keydown", e => {
  if (e.key === "Escape") {
    closeViewModal();
    closeEditModal();
  }
});

selectAll?.addEventListener("change", () => {
  document.querySelectorAll(".user-select-checkbox").forEach(cb => cb.checked = selectAll.checked);
  updateBulkDeleteBtn();
});

function updateBulkDeleteBtn() {
  const anyChecked = [...document.querySelectorAll(".user-select-checkbox")].some(cb => cb.checked);
  bulkDeleteBtn.disabled = !anyChecked;
}

document.querySelectorAll(".user-select-checkbox").forEach(cb =>
  cb.addEventListener("change", updateBulkDeleteBtn)
);

bulkDeleteBtn?.addEventListener("click", () => {
  const selected = [...document.querySelectorAll(".user-select-checkbox")].filter(cb => cb.checked);

  if (selected.length === 0) {
    return showToast("No users selected!", "warning");
  }

  if (confirm(`Delete ${selected.length} user(s)?`)) {
    document.getElementById("bulkDeleteForm").submit();
  }
});

async function handleEditSubmit(event) {
  event.preventDefault();

  const form = event.target;
  const id = editUserId.value;
  const name = editUserName.value;
  const email = editUserEmail.value;

  try {
    const response = await fetch(`/update/${id}`, {
      method: "PUT",
      body: JSON.stringify({ name, email }),
      headers: { "Content-Type": "application/json" }
    });

    const result = await response.json();

    if (response.ok) {
      showToast(result.message || "User updated successfully!", "success");
      closeEditModal();
      setTimeout(() => location.reload(), 1000);
    } else {
      showToast(result.error || "Failed to update user", "danger");
    }

  } catch (e) {
    console.error(e);
    showToast("An error occurred while updating user", "danger");
  }
}

chooseFileBtn?.addEventListener("click", () => fileInput.click());

fileInput?.addEventListener("change", e => {
  const file = e.target.files[0];
  uploadBtn.disabled = !file;
  selectedFileName.textContent = file ? file.name : "";
});
</script>

</body>
</html>
